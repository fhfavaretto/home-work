SELECT 
E2_FILIAL FILIAL,
E2__RAZAO FORNECEDOR,

SUM(ROUND(E2_VALOR *  COALESCE(EV_PERC,1),2)) VALOR,
SUM(ROUND( COALESCE(E5_VALOR,0) *  COALESCE(EV_PERC,1),2)) PAGO,
SUM(ROUND( COALESCE(E2_VALOR,0) *  COALESCE(EV_PERC,1),2)) - SUM(ROUND( COALESCE(E5_VALOR,0) *  COALESCE(EV_PERC,1),2)) SALDO

FROM SE2010 

LEFT JOIN SEV010 
ON EV_FILIAL = E2_FILIAL 
AND EV_PREFIXO = E2_PREFIXO 
AND EV_NUM = E2_NUM 
AND EV_CLIFOR = E2_FORNECE 
AND EV_LOJA = E2_LOJA 
AND EV_PARCELA = E2_PARCELA 
AND EV_TIPO = E2_TIPO 
AND SEV010.D_E_L_E_T_=' ' 

LEFT JOIN SE5010
ON E5_FILIAL = E2_FILIAL 
AND E5_PREFIXO = E2_PREFIXO 
AND E5_NUMERO = E2_NUM 
AND E5_CLIFOR = E2_FORNECE 
AND E5_LOJA = E2_LOJA 
AND E5_PARCELA = E2_PARCELA 
AND E5_TIPO = E2_TIPO 
AND SE5010.D_E_L_E_T_=' ' 
AND E5_SITUACA = ' ' 
AND (E5_RECONC = 'x' OR E5_LOTE <> ' ') 
AND E5_DATA BETWEEN '20170101' AND '20180831' 
AND E5_TIPODOC IN ('VL' , 'BA' , 'BL') 

JOIN SED010 
ON COALESCE(EV_NATUREZ , E2_NATUREZ) = ED_CODIGO 
AND SUBSTR(E2_FILIAL , 1 , 2) = SUBSTR(ED_FILIAL , 1 , 2) 
AND SED010.D_E_L_E_T_=' ' 

WHERE  E2_FILIAL BETWEEN '11032' AND '11032' 
AND E2_FORNECE BETWEEN '      ' AND 'ZZZZZZ' 
AND E2_LOJA BETWEEN '  ' AND 'ZZ' 
AND E2_PREFIXO BETWEEN '    ' AND 'ZZZ' 
AND E2_NUM BETWEEN '         ' AND 'ZZZZZZZZZ' 
AND E2_EMISSAO BETWEEN '20180101' AND '20180331' 
AND E2_VENCTO BETWEEN '20170101' AND '20501231' 
AND E2_TIPO NOT IN ('TX','FAT','PR''PA') 
AND E2_FORNECE NOT IN ('UNIAO','MUNIC') 
AND E2_PARCELA NOT IN ('0','00') 
AND SE2010.D_E_L_E_T_=' ' 
AND  COALESCE(EV_NATUREZ,E2_NATUREZ) BETWEEN '5104001001 ' AND '5104001001' 

GROUP BY E2_FILIAL, E2__RAZAO  
ORDER BY  E2_FILIAL, E2__RAZAO ;